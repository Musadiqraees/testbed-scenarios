#!/usr/bin/env ansible-playbook

- name: Bootstrap Python
  hosts: vms
  gather_facts: false
  roles:
    - ../roles/bootstrap

- name: Install packages and Docker
  hosts: vms
  tasks:
    - name: Install required packages with apt
      apt:
        name: [
          tree, curl, wget, git, jq,
          htop, bmon, iotop,
          software-properties-common, apt-transport-https, ca-certificates

          #linux-image-extra-$(uname -r)
          #linux-image-extra-virtual 
        ]
        state: present
        update_cache: yes
  roles:
    - ../roles/docker
    - ../roles/docker-compose

# TODO?
# echo -e 'Acquire::http::Timeout "20";\nAcquire::ftp::Timeout "10";' > /etc/apt/apt.conf.d/99timeout

# TODO?
# apt update && apt -y upgrade

# TODO limit the vms that install collector/injector/exposer?

- name: Install ZerOps components
  hosts: vms
  roles:
    #- ../roles/zerops-collector
    - ../roles/anomaly-injector
    - ../roles/docker-events-exposer

# TODO turn this into a role
#tasks:
#- include_tasks: ../../Common/Ansible/ebpf-agent-tasks.yml
#      tags: [ docker, ebpf-agent ]
#      become: true
