#!/usr/bin/env ansible-playbook

- name: Install Python
  tags: [ bootstrap ]
  hosts: all
  gather_facts: false
  tasks:
    - include_tasks: ../../Common/Ansible/bootstrap-python.yml
      become: true
    - include_tasks: ../../Common/Ansible/bootstrap-docker-tasks.yml
      become: true

- name: Setup VMs
  hosts:
    - vms
  become: yes
  vars:
    docker_compose_location: "/usr/local/bin/docker-compose"
  tasks:
    - include_tasks: ../../Common/Ansible/load_kernel_upgrade.yml 
      register: kernel_upgrade_status
    - include_tasks: ../../Common/Ansible/reboot_server.yml
      when: kernel_upgrade_status.changed
    - name: Install required packages 
      apt: name={{ item }} state=present update_cache=yes
      with_items:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - htop
        - bmon
        - jq
    - name: Add environment variable
      shell: echo "SERVICE_NAME=$(echo $(hostname) | tr "-" "\n" | sed -n "1p")" >> /etc/environment
    - name: Get docker apt key
      apt_key:
        id: 0EBFCD88
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    - name: register lsb_release
      command: lsb_release -cs
      register: lsb_release_cs
    #TODO debug lsb_release var
    #fix add repository issue
    - name: Add docker apt repository
      - apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu
        state: present
    - name: Install docker
      apt: name=docker-ce state=present update_cache=yes
    - name: Register variable
      command: uname -s
      register: uname_s
      changed_when: False
    - name: Register variable
      command: uname -m
      register: uname_m
      changed_when: False
    - name: Download docker compose
      get_url:
        url: https://github.com/docker/compose/releases/download/1.17.1/docker-compose-{{ uname_s.stdout }}-{{ uname_r.stdout }}
        dest: "{{ docker_compose_location }}"
        mode: 0755
    - name: apt update
      apt: update_cache=yes
    - name: apt upgrade
      apt: upgrade=dist
    - include_tasks: ../../Common/Ansible/reboot_server.yml


#- name: Install the Bitflow data collector and injector
#  hosts:
#    - hypervisors
#    - vms
#  tags: [ collector, injector ]
#  vars:
#    injector: "{{ injector_general }}"
#  tasks: 
#    - include_tasks: ../../Common/Ansible/bootstrap-docker-tasks.yml
#      become: true
#    - include_tasks: ../../Common/Ansible/bitflow-collector-tasks.yml
#      become: true
#    - include_tasks: ../../Common/Ansible/injector-tasks.yml
#      become: true




