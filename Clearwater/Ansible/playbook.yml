#!/usr/bin/env ansible-playbook

- name: Install Python
  tags: [ bootstrap ]
  hosts: all
  gather_facts: false
  tasks:
    - include_tasks: ../../Common/Ansible/bootstrap-python.yml
      become: true
    - include_tasks: ../../Common/Ansible/bootstrap-docker-tasks.yml
      become: true

- name: Setup VMs
  hosts:
    - vms
  vars:
    docker_compose_location: "/usr/local/bin/docker-compose"
  tasks:
    - include_tasks: ../../Common/Ansible/load_kernel_upgrade.yml
      become: true 
    - name: Reboot server
      command: reboot
      async: 0
      poll: 0
    - name: Wait for the server to finish rebooting
      local_action: wait_for host="{{ ansible_ssh_host }}" state=started
    - name: Install required packages 
      apt: name={{ item }} state=present update_cache=yes
      with_items:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - htop
        - bmon
        - jq
    - name: Add environment variable
      shell: echo -e "SERVICE_NAME=$(echo $(hostname) | tr "-" "\n" | sed -n "1p")" >> /etc/environment
    - name: Set ftp timeout configuration
      shell: echo -e 'Acquire::http::Timeout "20";\nAcquire::ftp::Timeout "10";' > /etc/apt/apt.conf.d/99timeout
    - name: Get docker metadata
      shell: |
        until type docker &> /dev/null; do
          curl --connect-timeout 10 -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
          apt-key fingerprint 0EBFCD88
          add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        done
    - name: Install docker
      apt: name=docker-ce state=present update_cache=yes
    - name: Register variable
      command: uname -s
      register: uname_s
      changed_when: False
    - name: Register variable
      command: uname -m
      register: uname_m
      changed_when: False
    - name: Download docker compose
      get_url:
        url: https://github.com/docker/compose/releases/download/1.17.1/docker-compose-{{ uname_s.stdout }}-{{ uname_r.stdout }}
        dest: "{{ docker_compose_location }}"
        mode: 0755
    - name: apt update
      apt: update_cache=yes
    - name: apt upgrade
      apt: upgrade=dist
    - include_tasks: ../../Common/Ansible/reboot_server.yml
      become: true


#- name: Install the Bitflow data collector and injector
#  hosts:
#    - hypervisors
#    - vms
#  tags: [ collector, injector ]
#  vars:
#    injector: "{{ injector_general }}"
#  tasks: 
#    - include_tasks: ../../Common/Ansible/bootstrap-docker-tasks.yml
#      become: true
#    - include_tasks: ../../Common/Ansible/bitflow-collector-tasks.yml
#      become: true
#    - include_tasks: ../../Common/Ansible/injector-tasks.yml
#      become: true




